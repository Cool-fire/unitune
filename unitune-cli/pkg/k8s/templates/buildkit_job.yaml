apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ .JobName }}"
  namespace: "{{ .Namespace }}"
  labels:
    app: unitune-builder
    build-id: "{{ .BuildID }}"
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 2
  template:
    metadata:
      labels:
        app: unitune-builder
        build-id: "{{ .BuildID }}"
    spec:
      restartPolicy: Never
      serviceAccountName: "{{ .ServiceAccountName }}"
      nodeSelector:
        kubernetes.io/os: linux
        karpenter.sh/capacity-type: on-demand
      volumes:
        - name: build-context
          emptyDir:
            sizeLimit: 5Gi
        - name: docker-config
          emptyDir:
            sizeLimit: 10Mi
      initContainers:
        - name: aws-setup
          image: public.ecr.aws/bitnami/aws-cli:latest
          env:
            - name: S3_BUCKET
              value: "{{ .S3Bucket }}"
            - name: S3_KEY
              value: "{{ .S3Key }}"
            - name: ECR_REGISTRY
              value: "{{ .ECRRegistry }}"
            - name: AWS_REGION
              value: "{{ .AWSRegion }}"
          volumeMounts:
            - name: build-context
              mountPath: /build
            - name: docker-config
              mountPath: /docker-config
          command: ["/bin/bash", "-c"]
          args:
            - |
              set -e
              echo "[1/3] Downloading build context from s3://${S3_BUCKET}/${S3_KEY}"
              aws s3 cp "s3://${S3_BUCKET}/${S3_KEY}" - | tar -xC /build
              echo "[2/3] Extracting build context ($(du -sh /build | cut -f1))"
              echo "[3/3] Configuring ECR authentication"
              mkdir -p /docker-config/.docker
              ECR_PASSWORD=$(aws ecr get-login-password --region ${AWS_REGION})
              cat > /docker-config/.docker/config.json <<EOF
              {
                "auths": {
                  "${ECR_REGISTRY}": {
                    "auth": "$(printf "AWS:%s" "${ECR_PASSWORD}" | base64 -w 0)"
                  }
                }
              }
              EOF
              unset ECR_PASSWORD
              echo "âœ“ Init complete"
          resources:
            requests:
              cpu: "250m"
              memory: "512Mi"
            limits:
              cpu: "1"
              memory: "1Gi"
      containers:
        - name: buildkit
          image: moby/buildkit:v0.13.0
          securityContext:
            privileged: true
          env:
            - name: IMAGE_URI
              value: "{{ .ECRRegistry }}/{{ .ImageName }}:{{ .ImageTag }}"
            - name: DOCKER_CONFIG
              value: "/docker-config/.docker"
          volumeMounts:
            - name: build-context
              mountPath: /build
              readOnly: true
            - name: docker-config
              mountPath: /docker-config
              readOnly: true
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              buildctl-daemonless.sh build \
                --progress=plain \
                --frontend dockerfile.v0 \
                --local context=/build \
                --local dockerfile=/build \
                --output type=image,name=${IMAGE_URI},push=true,compression=zstd,oci-mediatypes=true
          resources:
            requests:
              cpu: "2"
              memory: "4Gi"
            limits:
              cpu: "4"
              memory: "8Gi"